<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="FIT 笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="FIT 笔记">
<meta property="og:url" content="http://yoursite.com/2018/08/12/FIT-笔记/index.html">
<meta property="og:site_name" content="Semiyd&#39;s Blog">
<meta property="og:description" content="FIT 笔记">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-08-12T02:11:29.361Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="FIT 笔记">
<meta name="twitter:description" content="FIT 笔记">






  <link rel="canonical" href="http://yoursite.com/2018/08/12/FIT-笔记/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>FIT 笔记 | Semiyd's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Semiyd's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/12/FIT-笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Semiyd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semiyd's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">FIT 笔记
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-12 10:06:18 / Modified: 10:11:29" itemprop="dateCreated datePublished" datetime="2018-08-12T10:06:18+08:00">2018-08-12</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/U-boot/" itemprop="url" rel="index"><span itemprop="name">U-boot</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/U-boot/启动/" itemprop="url" rel="index"><span itemprop="name">启动</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/U-boot/启动/FIT/" itemprop="url" rel="index"><span itemprop="name">FIT</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><center><strong> FIT 笔记</strong></center><br><a id="more"></a></p>
<h1 id="FIT是什么"><a href="#FIT是什么" class="headerlink" title="FIT是什么"></a>FIT是什么</h1><p>是Flat Image Tree的简称。这东西是加强版的uImage。<br>由.its文件（image source file），用mkimage和dtc工具，编译成.itb文件。这个itb文件，其实包含了原来的uImage。<br>在原有的uImage基础上，引入.its文件，可以像类似.dts文件一样，进行配置，例如指定加载地址，执行地址，hash/md5，用哪个fdt设备树，类似的配置信息，都打包在一个uImage里面，更名为.itb<br>真正使用的时候，可以把itb像uImage一样加载都某个内存地址，然后bootm即可。这时候会打印出：<br>## Booting kernel from FIT Image at 00900000 …<br>这个FIT真正的灵活性在于，.itb可以包含多个kernel，多个dtb，多个ramdisk，多种加载和校验的方式。所有镜像全部打包在同一个itb里面（打包时候，从哪个路径去取这些镜像，its可以进行配置）。<br>而这多种内核/dtb镜像/启动参数，可组合出不同的”config”，这个所谓的”config”是.its里面的一种配置的集合。<br>并且一旦下载到RAM中去后，可以通过制定使用某个config的方式，达到灵活启动的目的。例如，u-boot通过识别当前的板子的型号信息，来挑选其中一种合适的config来启动。</p>
<p>例如its里面有这段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">configurations &#123; </span><br><span class="line">default = &quot;config@1&quot;; </span><br><span class="line">config@1 &#123; </span><br><span class="line">description = &quot;tqm5200 vanilla-2.6.23 configuration&quot;; </span><br><span class="line">kernel = &quot;kernel@1&quot;; </span><br><span class="line">ramdisk = &quot;ramdisk@1&quot;; </span><br><span class="line">fdt = &quot;fdt@1&quot;; </span><br><span class="line">&#125;; </span><br><span class="line">config@2 &#123; </span><br><span class="line">description = &quot;tqm5200s denx-2.6.23 configuration&quot;; </span><br><span class="line">kernel = &quot;kernel@2&quot;; </span><br><span class="line">ramdisk = &quot;ramdisk@1&quot;; </span><br><span class="line">fdt = &quot;fdt@2&quot;; </span><br><span class="line">&#125;; </span><br><span class="line">config@3&#123; </span><br><span class="line">description = &quot;tqm5200s denx-2.4.25 configuration&quot;; </span><br><span class="line">kernel = &quot;kernel@3&quot;; </span><br><span class="line">ramdisk = &quot;ramdisk@2&quot;; </span><br><span class="line">&#125;; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>它包含了3种配置，每种配置使用了不同的kernel、ramdisk和fdt，默认配置项由“default”指定，当然也可以在运行时指<br>定。<br>bootm 0x100000    使用默认的config@1<br>bootm 0x100000#config@2    使用config@2</p>
<p>itb的生成过程如下：<br>tqm5200.its<br>+<br>vmlinux.bin.gz       mkimage + dtc           xfer to target<br>eldk-4.2-ramdisk  ————–&gt; tqm5200.itb ————–&gt; bootm<br>tqm5200.dtb                           /|\<br>…                                    |<br>                                 ‘new uImage’</p>
<p>its文件的具体语法：<br>    参见《Linux\Uboot\启动\FIT\doc\uImage.FIT\its文件格式说明.txt》<br>    和Linux\Uboot\启动\FIT\doc\uImage.FIT\下面的.its例子</p>
<h1 id="有关CONFIG-SPL-LOAD-FIT"><a href="#有关CONFIG-SPL-LOAD-FIT" class="headerlink" title="有关CONFIG_SPL_LOAD_FIT"></a>有关CONFIG_SPL_LOAD_FIT</h1><p>在了解了FIT的基本概念以后，现在有一个进一步的东西，叫做CONFIG_SPL_LOAD_FIT<br>这是u-boot的.config里面的一个选项，Boot images  —&gt;[*] Enable SPL loading U-Boot as a FIT<br>如果选为y的话，则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">config SPL_LOAD_FIT</span><br><span class="line">        bool &quot;Enable SPL loading U-Boot as a FIT&quot;</span><br><span class="line">        depends on FIT</span><br><span class="line">        help</span><br><span class="line">          Normally with the SPL framework a legacy image is generated as part</span><br><span class="line">          of the build. This contains U-Boot along with information as to</span><br><span class="line">          where it should be loaded. This option instead enables generation</span><br><span class="line">          of a FIT (Flat Image Tree) which provides more flexibility. In</span><br><span class="line">          particular it can handle selecting from multiple device tree</span><br><span class="line">          and passing the correct one to U-Boot.</span><br></pre></td></tr></table></figure></p>
<p>其作用是Enable SPL loading U-Boot as a FIT<br>也就是说，SPL把u-boot镜像，作为一个FIT镜像来加载。<br>之前说的是把uImage包装成FIT<br>那现在是把u-boot.bin包装成FIT<br>这里面原理是一样的。<br>这样做的结果，就是u-boot（am57xx平台的u-boot的FIT镜像，就是经过u-boot-nodtb.bin，组装成为的u-boot.img）里面会包含dtb。<br>注意，这里的dtb，是指u-boot源码目录的arch/arm/dts/下面的dts编译成的dtb。和kernel的arch/arm/boot/dts/下面的dts文件，半毛钱关系没有。<br>这个dtb是仅供u-boot本身使用的dtb。<br>SPL会根据板子型号，从FIT镜像（u-boot.img）中选择合适的dtb传给u-boot。（就好像u-boot根据板子型号，从FIT镜像（xxx.itb）中选择合适的dtb传给kernel，原理相同）<br>这里还涉及另外一个配置选项，叫CONFIG_OF_LIST。解释如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">config OF_LIST</span><br><span class="line">        string &quot;List of device tree files to include for DT control&quot;</span><br><span class="line">        depends on SPL_LOAD_FIT || FIT_EMBED</span><br><span class="line">        default DEFAULT_DEVICE_TREE</span><br><span class="line">        help</span><br><span class="line">          This option specifies a list of device tree files to use for DT</span><br><span class="line">          control. These will be packaged into a FIT. At run-time, U-boot</span><br><span class="line">          or SPL will select the correct DT to use by examining the</span><br><span class="line">          hardware (e.g. reading a board ID value). This is a list of</span><br><span class="line">          device tree files (without the directory or .dtb suffix)</span><br><span class="line">          separated by &lt;space&gt;.</span><br></pre></td></tr></table></figure></p>
<p>打开configs/am57xx_evm_defconfig，可以看到<br>CONFIG_OF_LIST=”am57xx-beagle-x15 am57xx-beagle-x15-revb1 am57xx-beagle-x15-revc am57xx-evm-reva3 am572x-idk am571x-idk am574x-idk”<br>这个自定义的dts的列表，就是会参与编译成dtb的名单。但时候启动的时候，合适的dtb会被选中。</p>
<p>u-boot.img的生成过程：<br>tools/mkimage -f auto -A arm -T firmware -C none -O u-boot -a 0x80800000 -e 0 -n “U-Boot 2017.01 for am57xx board” -E -b arch/arm/dts/am57xx-beagle-x15.dtb<br>    -b arch/arm/dts/am57xx-beagle-x15-revb1.dtb -b arch/arm/dts/am57xx-beagle-x15-revc.dtb -b arch/arm/dts/am57xx-evm-reva3.dtb -b arch/arm/dts/am572x-idk.dtb<br>    -b arch/arm/dts/am571x-idk.dtb -b arch/arm/dts/am574x-idk.dtb -d u-boot-nodtb.bin u-boot.img  &gt;/dev/null<br>可见：u-boot-nodtb.bin + dtb文件 = u-boot.img </p>
<p>u-boot-dtb.bin的生成过程：<br>cat u-boot-nodtb.bin dts/dt.dtb &gt; u-boot-dtb.bin</p>
<p>u-boot-nodtb.bin的生成过程：（就是传统的u-boot.bin的生成过程）<br>arm-linux-gnueabihf-objcopy –gap-fill=0xff  -j .text -j .secure_text -j .secure_data -j .rodata -j .hash -j .data -j .got -j .got.plt -j .u_boot_list -j .rel.dyn -j .efi_runtime -j .efi_runtime_rel -O binary  u-boot u-boot-nodtb.bin</p>
<p>u-boot的FIT镜像，是否像内核一样，需要用its去描述一下？<br>    其实u-boot的FIT并不包含its的信息，算是一种简化的FIT镜像。只包含镜像和dtb两样东西。<br>    所以代码中的名字是spl_load_simple_fit()也就是simple FIT。<br>    u-boot的代码里面，能搜到its文件。但那些文件都是生成内核的itb用的，里面也都是配置内核的一些内容。</p>
<h1 id="一个和FIT相关的问题的实例，SPL启动过程中报错No-matching-DT-out-of-these-options-的解决"><a href="#一个和FIT相关的问题的实例，SPL启动过程中报错No-matching-DT-out-of-these-options-的解决" class="headerlink" title="一个和FIT相关的问题的实例，SPL启动过程中报错No matching DT out of these options:的解决"></a>一个和FIT相关的问题的实例，SPL启动过程中报错No matching DT out of these options:的解决</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">打印出No matching DT out of these options:的来源是：</span><br><span class="line">	board_init_r()-&gt;boot_from_devices()-&gt;spl_load_image()-&gt;spl_mmc_load_image()-&gt;spl_mmc_do_fs_boot()-&gt;spl_load_image_fat()-&gt;spl_load_simple_fit()-&gt;fit_select_fdt()</span><br><span class="line">	</span><br><span class="line">	boot_from_devices()会通过spl_ll_find_loader()寻找spl_mmc.c里面用SPL_LOAD_IMAGE_METHOD宏来静态注册过的struct spl_image_loader</span><br><span class="line">	</span><br><span class="line">	这里涉及一个概念，FIT是什么东西？	</span><br><span class="line">		参见Linux\Uboot\启动\FIT\</span><br><span class="line">		最关键的是，首先u-boot-2017.01并未编译出任何itb文件。</span><br><span class="line">		即使是正常的AM571x-IDK，也没有## Booting kernel from FIT Image at这句话。总之FIT根本没启用。但既然FIT没启用，那怎么会去调用spl_load_simple_fit()??</span><br><span class="line">			就是因为配置了CONFIG_SPL_LOAD_FIT。这个fit指u-boot.img，而不是itb文件。</span><br><span class="line"></span><br><span class="line">	有必要去跟下正常的AM571x-IDK的启动流程			</span><br><span class="line">		fit_select_fdt()会返回正确的结果：	FIT: Selected &apos;am571x-idk&apos;</span><br><span class="line">		这时候要是删除rootfs的boot/am571x-idk.dtb呢？	完全不影响启动！</span><br><span class="line">		删除boot/*.dtb试试？	</span><br><span class="line">			依然提示	FIT: Selected &apos;am571x-idk&apos;</span><br><span class="line">			只是真正启动内核的时候，提示** File not found /boot/am571x-idk-lcd-osd101t2587.dtb **		</span><br><span class="line">		说明fit_select_fdt()所寻找的设备树，根本不在/boot下面（spl_load_image_fat()可以印证，因为/boot是ext3格式的，fat方式怎么可能读的出来？）</span><br><span class="line">		在spl_load_image_fat()里面，spl_load_simple_fit()之前，有个file_fat_read()的动作，这个动作的入参filename就是u-boot.img！由此证明这些信息（FIT/dtb）应该是在u-boot.img里面。</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">	CONFIG_SPL_LOAD_FIT相关</span><br><span class="line">		参见Linux\Uboot\启动\FIT\</span><br><span class="line">	</span><br><span class="line">	展开fit_select_fdt()内部的流程进一步分析，里面的原理其实是遍历u-boot.img里面已有的dtb的内容，把每个可能的dtb的board name取出，和实际的板子型号做比较。</span><br><span class="line">	这个过程由board_fit_config_name_match()完成。如果匹配，则意味着其中的某个dtb被选中了。</span><br><span class="line">	所以board_fit_config_name_match的函数内容是由每个不同的cpu平台自己定义的。而fit_select_fdt()所在的common_fit.c却是跨平台通用的。</span><br><span class="line">	考虑到当前的板子就是am5718的，所以和am571x-idk最接近。考虑修改board/ti/am57xx/board.c：</span><br><span class="line">	#define board_is_am571x_idk()	board_ti_is(&quot;AM571IDK&quot;)</span><br><span class="line">	改为</span><br><span class="line">	#define board_is_am571x_idk()	1</span><br><span class="line">	这样的话，之前的beagle_x15_lisa_regs就不要改了，因为相当于board name写死成am571x-idk了，会去使用am571x_idk_lisa_regs。</span><br><span class="line">	而am571x_idk_lisa_regs的值，正好就是之前beagle_x15_lisa_regs要改成的值。</span><br><span class="line"></span><br><span class="line">	为什么spl会扯到fit？这不是u-boot要干的事情么？为什么spl阶段就要去load dtb？</span><br><span class="line">		因为spl也可以支持fit   </span><br><span class="line"></span><br><span class="line">	u-boot本身有自己的fdt？？					</span><br><span class="line">		是的，见”Linux\Uboot\驱动\device tree“</span><br><span class="line"></span><br><span class="line">	u-boot阶段的dtb，和rootfs/boot/下面的dtb，是什么关系?			</span><br><span class="line">		毫无关系</span><br><span class="line"></span><br><span class="line">	board name被认出来是什么了？</span><br><span class="line">		setup_board_eeprom_env()尚未被调用就挂了</span><br><span class="line">		原先应该是unknown</span><br><span class="line"></span><br><span class="line">	为什么用fat方式去查找dtb？dtb不是存放在ext3区域吗？</span><br><span class="line">		因为其实dtb已经u-boot.img</span><br><span class="line"></span><br><span class="line">	u-boot自己的its用到了没有？</span><br><span class="line">		没有通过its配置，但结果和用了its一样。详见下面的分析：</span><br><span class="line"></span><br><span class="line">	spl_load_image()都需要load些什么内容？			</span><br><span class="line">		spl_load_image()其实由SPL_LOAD_IMAGE_METHOD()注册为spl_mmc_load_image()</span><br><span class="line">		因为是访问fat区，所以走case MMCSD_MODE_FS分支的spl_mmc_do_fs_boot()。在这函数中，spl_load_image_fat()会：</span><br><span class="line">		用file_fat_read读取u-boot.img的头部，sizeof(struct image_header)大小的数据。</span><br><span class="line">		假如image_header内部用image_get_magic(header) == FDT_MAGIC条件成立的话，意味着找到了一个FIT镜像。这时候就可以用spl_load_simple_fit()加载FIT。</span><br><span class="line">		因为确定读的对象是FIT镜像，那么就可以按照FIT的内部格式来读取了。FIT有两种路径，分别放置镜像和配置（dtb）</span><br><span class="line">		#define FIT_IMAGES_PATH		&quot;/images&quot;</span><br><span class="line">		#define FIT_CONFS_PATH		&quot;/configurations&quot;</span><br><span class="line">		从FIT镜像的中，找FIT_IMAGES_PATH所在的位置。把这个位置的node读上来，便可以进一步读到&quot;data-offset&quot;，&quot;data-size&quot;，&quot;load&quot;加载地址。</span><br><span class="line">		有了这些信息，就知道u-boot大小，在哪里，要load到哪里去，然后就可以把u-boot本身读上来。</span><br><span class="line">		接着进入fit_select_fdt()，这个函数的内容是：</span><br><span class="line">		找到FIT_CONFS_PATH所在的位置。此处的镜像内容，包含很多个node。每个node，其实都对应一个dtb的信息。</span><br><span class="line">		遍历所有的node，首先从node开头取出&quot;description&quot;字段的内容，这里面其实就是板子名称。</span><br><span class="line">		获取到名称以后，用board_fit_config_name_match(name)（平台相关代码），去判断，当前板子的名称，是不是和传入的板子名称一致。假如一致，其实就是dtb和板子匹配了。</span><br><span class="line">		这时候从FIT_CONFS_PATH所在的位置，进一步取出FIT_FDT_PROP，意即&quot;fdt&quot;类型的配置</span><br><span class="line">		取出FIT_FDT_PROP的&quot;data-offset&quot;和&quot;data-size&quot;。把这个正确的dtb读上来，放在刚刚读出来的u-boot后面。</span><br><span class="line">		上面的这些node啊，FIT_XXX_PATH，其实就是FIT镜像的结构。具体定义在include/image.h中：</span><br><span class="line">/*******************************************************************/</span><br><span class="line">/* New uImage format specific code (prefixed with fit_) */</span><br><span class="line">/*******************************************************************/</span><br><span class="line"></span><br><span class="line">#define FIT_IMAGES_PATH		&quot;/images&quot;</span><br><span class="line">#define FIT_CONFS_PATH		&quot;/configurations&quot;</span><br><span class="line"></span><br><span class="line">/* hash/signature node */</span><br><span class="line">#define FIT_HASH_NODENAME	&quot;hash&quot;</span><br><span class="line">#define FIT_ALGO_PROP		&quot;algo&quot;</span><br><span class="line">#define FIT_VALUE_PROP		&quot;value&quot;</span><br><span class="line">#define FIT_IGNORE_PROP		&quot;uboot-ignore&quot;</span><br><span class="line">#define FIT_SIG_NODENAME	&quot;signature&quot;</span><br><span class="line"></span><br><span class="line">/* image node */</span><br><span class="line">#define FIT_DATA_PROP		&quot;data&quot;</span><br><span class="line">#define FIT_TIMESTAMP_PROP	&quot;timestamp&quot;</span><br><span class="line">#define FIT_DESC_PROP		&quot;description&quot;</span><br><span class="line">#define FIT_ARCH_PROP		&quot;arch&quot;</span><br><span class="line">#define FIT_TYPE_PROP		&quot;type&quot;</span><br><span class="line">#define FIT_OS_PROP		&quot;os&quot;</span><br><span class="line">#define FIT_COMP_PROP		&quot;compression&quot;</span><br><span class="line">#define FIT_ENTRY_PROP		&quot;entry&quot;</span><br><span class="line">#define FIT_LOAD_PROP		&quot;load&quot;</span><br><span class="line"></span><br><span class="line">/* configuration node */</span><br><span class="line">#define FIT_KERNEL_PROP		&quot;kernel&quot;</span><br><span class="line">#define FIT_RAMDISK_PROP	&quot;ramdisk&quot;</span><br><span class="line">#define FIT_FDT_PROP		&quot;fdt&quot;</span><br><span class="line">#define FIT_LOADABLE_PROP	&quot;loadables&quot;</span><br><span class="line">#define FIT_DEFAULT_PROP	&quot;default&quot;</span><br><span class="line">#define FIT_SETUP_PROP		&quot;setup&quot;</span><br><span class="line">#define FIT_FPGA_PROP		&quot;fpga&quot;</span><br><span class="line">		其实可以看到，u-boot.img这个FIT镜像，虽然没有用its配置文件，但其实它内部的结构，也是严格按照FIT镜像分布的。(可参考&quot;FIT内部组成图示.png&quot;)</span><br><span class="line">		也就是分为hash/signature node.image node.configuration node	</span><br><span class="line">		其实参考doc/uImage.FIT/*.its这些its例子，可以看到，its也一样分成hash/signature .image .configuration 三类节点名称。</span><br><span class="line">		说白了就是，u-boot.img这个FIT，虽然没用its，但最终做成的FIT镜像，可以看成是用了its配置过的，只不过它是直接做好了FIT，不通过its配置这个步骤，直接跳到FIT镜像这个结果了。</span><br></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/12/uboot编译流程/" rel="next" title="uboot编译流程">
                <i class="fa fa-chevron-left"></i> uboot编译流程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/12/启动速度优化/" rel="prev" title="启动速度优化">
                启动速度优化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Semiyd</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">241</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">130</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#FIT是什么"><span class="nav-number">1.</span> <span class="nav-text">FIT是什么</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#有关CONFIG-SPL-LOAD-FIT"><span class="nav-number">2.</span> <span class="nav-text">有关CONFIG_SPL_LOAD_FIT</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一个和FIT相关的问题的实例，SPL启动过程中报错No-matching-DT-out-of-these-options-的解决"><span class="nav-number">3.</span> <span class="nav-text">一个和FIT相关的问题的实例，SPL启动过程中报错No matching DT out of these options:的解决</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Semiyd</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
