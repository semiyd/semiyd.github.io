<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Regulator笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="Regulator笔记">
<meta property="og:url" content="http://yoursite.com/2018/08/05/Regulator笔记/index.html">
<meta property="og:site_name" content="Semiyd&#39;s Blog">
<meta property="og:description" content="Regulator笔记">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-07-12T13:35:20.550Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Regulator笔记">
<meta name="twitter:description" content="Regulator笔记">






  <link rel="canonical" href="http://yoursite.com/2018/08/05/Regulator笔记/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Regulator笔记 | Semiyd's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Semiyd's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/05/Regulator笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Semiyd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semiyd's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Regulator笔记
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-05 10:28:28" itemprop="dateCreated datePublished" datetime="2018-08-05T10:28:28+08:00">2018-08-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-07-12 21:35:20" itemprop="dateModified" datetime="2020-07-12T21:35:20+08:00">2020-07-12</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/Kernel/" itemprop="url" rel="index"><span itemprop="name">Kernel</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/Kernel/驱动/" itemprop="url" rel="index"><span itemprop="name">驱动</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/Kernel/驱动/Regulator/" itemprop="url" rel="index"><span itemprop="name">Regulator</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><center><strong>Regulator笔记</strong></center><br><a id="more"></a><br>=============================内核子系统之regulator=============================<br>regulator子系统，是针对pmic类的芯片，针对电压电流的输出做调节之用。<br>在系统启动的时候，开启相应的电源供应<br>在有需要的时候，改变电源供应的电压/电流，达到提高能效的目的</p>
<p>考虑到实际硬件的电路情况，regulator子系统在设计的时候需要考虑下面几点：<br>1.所有电压/电流需要能事先规定一个最大/最小值作为有效范围。否则因为软件bug导致一旦超出范围，会烧毁硬件。<br>2.很多设备除了初始化的时候开下电源，别的时候完全不会去调节电压，需要尽量简化API接口。<br>3.硬件上电源这块经常存在级联的情况，一路电源的输入是另外一路电源的输出，在软件架构上要能反映出来（即supplier的概念）</p>
<p>整体软件架构参考“regulator子系统软件架构.png”<br>这个架构从下往上看，大体如下：<br>最底下是pmic的硬件<br>往上就是pmic的驱动<br>再往上就是子系统本身了。<br>子系统和驱动对接的部分，分成两块，driver和machine<br>所谓driver，就是类似devm_regulator_register这种接口，pmic的驱动用来向子系统注册。<br>所谓machine，是用来静态的配置电路上regulator的级联关系，最大/最小值范围等。早期是写在board文件里的，结构体名字是struct regulator_init_data。<br>现在的内核其实就是写在dts里面的配置。<br>最终通过of_get_regulator_init_data接口，同样是去填充struct regulator_init_data。<br>再往上就是子系统核心部分的逻辑。对应代码就是drivers/regulator/core.c<br>最后和电源的使用者（成为consumer）做接口的，有两部分。<br>一部分是针对内核内部的consumer的，一部分是针对用户空间的consumer的（sysfs接口）。</p>
<h2 id="下面针对提到的子系统的组件，做下详细的解释："><a href="#下面针对提到的子系统的组件，做下详细的解释：" class="headerlink" title="下面针对提到的子系统的组件，做下详细的解释："></a>下面针对提到的子系统的组件，做下详细的解释：</h2><p>driver:<br>主要有两部分。<br>1.注册/注销pmic驱动：<br>struct regulator_dev <em>devm_regulator_register(struct device </em>dev,<br>                  const struct regulator_desc <em>regulator_desc,<br>                  const struct regulator_config </em>config)<br>这里面主要是两个入参：<br>a.regulator_desc{}<br>描述了regulator的属性，名称，电压电流范围，设置电压电流的回调函数等。举例：<br>static const struct regulator_desc acp_da7219_desc = {<br>    .name = “reg-fixed-1.8V”,<br>    .type = REGULATOR_VOLTAGE,<br>    .owner = THIS_MODULE,<br>    .ops = &amp;acp_da7219_ops,<br>    .fixed_uV = 1800000, /<em> 1.8V </em>/<br>    .n_voltages = 1,<br>};<br>b.regulator_config{}<br>描述了regulator的配置。最常见的是regulator_init_data{}。举例：<br>static struct regulator_config acp_da7219_cfg = {<br>    .init_data = &amp;acp_da7219_data,<br>};<br>static struct regulator_init_data acp_da7219_data = {<br>    .constraints = {<br>        .always_on = 1,<br>    },<br>    .num_consumer_supplies = ARRAY_SIZE(acp_da7219_supplies),<br>    .consumer_supplies = acp_da7219_supplies,<br>};<br>static struct regulator_consumer_supply acp_da7219_supplies[] = {<br>    REGULATOR_SUPPLY(“VDD”, “i2c-DLGS7219:00”),<br>    REGULATOR_SUPPLY(“VDDMIC”, “i2c-DLGS7219:00”),<br>    REGULATOR_SUPPLY(“VDDIO”, “i2c-DLGS7219:00”),<br>    REGULATOR_SUPPLY(“IOVDD”, “ADAU7002:00”),<br>};<br>REGULATOR_SUPPLY的第一个入参是supply方，第二个入参是consumer方。<br>和dts里面定义smps12-in-supply = &lt;&amp;vmain&gt;;这种，效果是一样的。</p>
<p>struct regulator_dev <em>regulator_register(struct regulator_desc </em>regulator_desc,<br>                     const struct regulator_config <em>config);<br>void regulator_unregister(struct regulator_dev </em>rdev);<br>2.注册通知驱动层的回调函数<br>此举主要针对过热，过压等异常情况，需要通知驱动层的：<br>int regulator_notifier_call_chain(struct regulator_dev <em>rdev,<br>                  unsigned long event, void </em>data);<br>int regulator_register_notifier(struct regulator <em>regulator,<br>                  struct notifier_block </em>nb)</p>
<hr>
<p>machine:<br>这个组件，对外的接口，其实主要就是这个regulator_init_data结构体：<br>struct regulator_init_data {<br>    const char <em>supply_regulator;        /</em> or NULL for system supply */</p>
<pre><code>struct regulation_constraints constraints;

int num_consumer_supplies;
struct regulator_consumer_supply *consumer_supplies;

/* optional regulator machine specific init */
int (*regulator_init)(void *driver_data);
void *driver_data;    /* core does not touch this */
</code></pre><p>};<br>这个结构体，可以在板级board文件里面填充好，也可以在dts里面写好，通过of_get_regulator_init_data接口来填充。<br>而这个结构体，作为regulator_config的一个成员。<br>struct regulator_config {<br>    struct device <em>dev;<br>    const struct regulator_init_data </em>init_data;<br>    void <em>driver_data;<br>    struct device_node </em>of_node;<br>    struct regmap *regmap;</p>
<pre><code>bool ena_gpio_initialized;
int ena_gpio;
unsigned int ena_gpio_invert:1;
unsigned int ena_gpio_flags;
</code></pre><p>};<br>最终跟着regulator_config{}，依靠devm_regulator_register注册到regulator子系统里面去。</p>
<p>下面举个例子来说明具体的配置过程：<br>假设硬件上有如下的级联结构：<br>  Regulator-1 -+-&gt; Regulator-2 –&gt; [Consumer A @ 1.8 - 2.0V]<br>               |<br>               +-&gt; [Consumer B @ 3.3V]<br>可以看到，硬件上，A是从Regulator-2供电，B是从Regulator-1供电。而Regulator-2也是从Regulator-1供电的。<br>如何从软件角度去描述上面这个电路？<br>machine子系统提供一个regulator_consumer_supply的结构体，专门用来描述supplier和consumer之间的关系：<br>struct regulator_consumer_supply {<br>    const char <em>dev_name;    /</em> consumer dev_name() <em>/<br>    const char </em>supply;    /<em> consumer supply - e.g. “vcc” </em>/<br>};<br>具体到此处就是：<br>static struct regulator_consumer_supply regulator1_consumers[] = {<br>{<br>    .dev_name    = “consumer B”,<br>    .supply        = “Vcc”,<br>},};</p>
<p>static struct regulator_consumer_supply regulator2_consumers[] = {<br>{<br>    .dev    = “consumer A”,<br>    .supply    = “Vcc”,<br>},};<br>但此处尚未涉及如何描述regulator之间的级联。别急，接着往下看：<br>这时候就可以填充regulator_init_data了：<br>static struct regulator_init_data regulator1_data = {<br>    .constraints = {<br>        .name = “Regulator-1”,<br>        .min_uV = 3300000,<br>        .max_uV = 3300000,<br>        .valid_modes_mask = REGULATOR_MODE_NORMAL,<br>    },<br>    .num_consumer_supplies = ARRAY_SIZE(regulator1_consumers),<br>    .consumer_supplies = regulator1_consumers,<br>};<br>可以看到，在regulator_init_data，需要填上刚刚涉及的regulator_consumer_supply内容。<br>除此以外，还填充了最大/最小电压；<br>设置了valid_modes_mask。有关这个mode，见下面的解释：</p>
<ul>
<li>Mode       Description</li>
<li>FAST       Regulator can handle fast changes in it’s load.</li>
<li>e.g. useful in CPU voltage &amp; frequency scaling where</li>
<li>load can quickly increase with CPU frequency increases.<br>*</li>
<li>NORMAL     Normal regulator power supply mode. Most drivers will</li>
<li>use this mode.<br>*</li>
<li>IDLE       Regulator runs in a more efficient mode for light</li>
<li>loads. Can be used for devices that have a low power</li>
<li>requirement during periods of inactivity. This mode</li>
<li>may be more noisy than NORMAL and may not be able</li>
<li>to handle fast load switching.<br>*</li>
<li>STANDBY    Regulator runs in the most efficient mode for very</li>
<li>light loads. Can be used by devices when they are</li>
<li>in a sleep/standby state. This mode is likely to be</li>
<li>the most noisy and may not be able to handle fast load</li>
<li>switching.<br>*</li>
<li>NOTE: Most regulators will only support a subset of these modes. Some</li>
<li>will only just support NORMAL.<br>*</li>
<li>These modes can be OR’ed together to make up a mask of valid register modes.<br>*/</li>
</ul>
<p>上面是Regulator-1，接着看Regulator-2：<br>static struct regulator_init_data regulator2_data = {<br>    .supply_regulator = “Regulator-1”,<br>    .constraints = {<br>        .min_uV = 1800000,<br>        .max_uV = 2000000,<br>        .valid_ops_mask = REGULATOR_CHANGE_VOLTAGE,<br>        .valid_modes_mask = REGULATOR_MODE_NORMAL,<br>    },<br>    .num_consumer_supplies = ARRAY_SIZE(regulator2_consumers),<br>    .consumer_supplies = regulator2_consumers,<br>};<br>可以看到，此处就写清楚了Regulator-1和Regulator-2的关系，依靠supply_regulator成员。<br>将来Consumer A如果要打开电源，core部分就会根据这个级联信息，同时打开Regulator-1和Regulator-2。</p>
<p>最后，把这两个regulator_init_data{}，作为.platform_data，注册到platform_device里面去。<br>有两个regulator_init_data{}，就注册两个platform_device<br>static struct platform_device regulator_devices[] = {<br>{<br>    .name = “regulator”,<br>    .id = DCDC_1,<br>    .dev = {<br>        .platform_data = &amp;regulator1_data,<br>    },<br>},<br>{<br>    .name = “regulator”,<br>    .id = DCDC_2,<br>    .dev = {<br>        .platform_data = &amp;regulator2_data,<br>    },<br>},<br>};<br>/<em> register regulator 1 device </em>/<br>platform_device_register(&amp;regulator_devices[0]);</p>
<p>/<em> register regulator 2 device </em>/<br>platform_device_register(&amp;regulator_devices[1]);</p>
<p>相应的，在regulator cell的platform_driver驱动里面，会针对这两个platform_device做两次probe，从而做两次devm_regulator_register，把这两个regulator设备都注册到子系统里面去。</p>
<p>除了在板级初始化代码里面配置regulator_init_data{}以外，目前主要的方式是在dts下配置：<br>例如下面这个例子：<br>        tps659038_pmic {<br>            compatible = “ti,tps659038-pmic”;</p>
<pre><code>    smps12-in-supply = &lt;&amp;vmain&gt;;
    smps3-in-supply = &lt;&amp;vmain&gt;;
    smps45-in-supply = &lt;&amp;vmain&gt;;
    smps6-in-supply = &lt;&amp;vmain&gt;;
    smps7-in-supply = &lt;&amp;vmain&gt;;
    smps8-in-supply = &lt;&amp;vmain&gt;;
    smps9-in-supply = &lt;&amp;vmain&gt;;
    ldo1-in-supply = &lt;&amp;vmain&gt;;
    ldo2-in-supply = &lt;&amp;vmain&gt;;
    ldo3-in-supply = &lt;&amp;vmain&gt;;
    ldo4-in-supply = &lt;&amp;vmain&gt;;
    ldo9-in-supply = &lt;&amp;vmain&gt;;
    ldoln-in-supply = &lt;&amp;vmain&gt;;
    ldousb-in-supply = &lt;&amp;vmain&gt;;
    ldortc-in-supply = &lt;&amp;vmain&gt;;

    regulators {
        smps12_reg: smps12 {
            /* VDD_MPU */
            regulator-name = &quot;smps12&quot;;
            regulator-min-microvolt = &lt;850000&gt;;
            regulator-max-microvolt = &lt;1250000&gt;;
            regulator-always-on;
            regulator-boot-on;
        };
        ...等等各路输出的配置
    };
}
</code></pre><p>dts里面完全可以配置出刚刚用板级文件填写的那些结构体信息。<br>注：<br>xxx-supply = &lt;&amp;ldo1&gt;的dts节点，是内核regulator子系统的规则。regulator子系统，回去解析xxx-supply，把supply字段剥离。</p>
<h2 id="最终xxx就是consumer-，ldo1是supplier"><a href="#最终xxx就是consumer-，ldo1是supplier" class="headerlink" title="最终xxx就是consumer ，ldo1是supplier"></a>最终xxx就是consumer ，ldo1是supplier</h2><p>core</p>
<h2 id="子系统核心逻辑"><a href="#子系统核心逻辑" class="headerlink" title="子系统核心逻辑"></a>子系统核心逻辑</h2><p>consumer接口<br>1.开放给内核内部的接口。<br>这部分接口高度类似clk子系统的接口。</p>
<p>获取和释放regulator:<br>regulator = regulator_get(dev, “Vcc”);            获取，通常在consumer驱动probe的时候做<br>regulator_put(regulator);                释放，通常在consumer驱动remove的时候做</p>
<p>开启regulator:<br>int regulator_enable(regulator);<br>如果已经开启（有别的consumer在用），则不会重复开启</p>
<p>关闭regulator：<br>int regulator_disable(regulator);<br>如果有别的consumer在用，则无法关闭。</p>
<p>紧急关闭regulator：<br>int regulator_force_disable(regulator);<br>无视别的consumer，直接关闭。</p>
<p>动态调整电压（通常用于cpufreq驱动，sd驱动针对不同速率需要不同电压）<br>int regulator_set_voltage(regulator, min_uV, max_uV);</p>
<p>获取当前电压的设置<br>int regulator_get_voltage(regulator);<br>无法体现是否电压正在输出，只能获取电压值的设定。所以需要配合int regulator_is_enabled(regulator);来判定是否是实际输出的电压。</p>
<p>动态调整电流（通常用于lcd backlight驱动，usb驱动限流500mA）<br>int regulator_set_current_limit(regulator, min_uA, max_uA);</p>
<p>获取当前电流的设置<br>int regulator_get_current_limit(regulator);<br>无法体现是否电流正在输出，只能获取电流值的设定。所以需要配合int regulator_is_enabled(regulator);来判定是否是实际输出的电流。</p>
<p>regulator模式的设置（不常用）<br>这里的模式，是指之前提到过的FAST  NORMAL IDLE STANDBY<br>根据实际使用的情况，针对regulator设置正确的模式，可以省电。<br>consumer可以通过下面两个API来影响regulator的模式（如果有模式可以选。也可能regulator注册的时候只有一种模式。）<br>int regulator_set_load(struct regulator <em>regulator, int load_uA);<br>告诉子系统，当前的load是多少，让子系统结合别的consumer的情况，来决定模式。<br>int regulator_set_mode(struct regulator </em>regulator, unsigned int mode);<br>直接暴力设置模式，无视别的consumer的情况</p>
<p>直接操作regulator寄存器<br>借助regmap子系统，consumer可以获取regulator具体的操作方式（i2c? 寄存器的值，寄存器号？等等）<br>struct regmap <em>regulator_get_regmap(struct regulator </em>regulator);<br>int regulator_get_hardware_vsel_register(struct regulator <em>regulator,<br>                     unsigned </em>vsel_reg,<br>                     unsigned <em>vsel_mask);<br>int regulator_list_hardware_vsel(struct regulator </em>regulator,<br>                 unsigned selector);<br>举例：<br>    regmap = regulator_get_regmap(td-&gt;vdd_reg);<br>    i2c_dev = regmap_get_device(regmap);<br>    i2c_client = to_i2c_client(i2c_dev);<br>    td-&gt;i2c_slave_addr = i2c_client-&gt;addr;<br>    ret = regulator_get_hardware_vsel_register(td-&gt;vdd_reg,<br>                           &amp;vsel_reg,<br>                           &amp;vsel_mask);<br>    if (ret &lt; 0) {<br>        dev_err(td-&gt;dev,<br>            “regulator unsuitable for DFLL I2C operation\n”);<br>        return -EINVAL;<br>    }<br>    td-&gt;i2c_reg = vsel_reg;<br>    ret = dfll_build_i2c_lut(td);//至此，获取了操作i2c寄存器的具体细节，可以真正来直接读写i2c寄存器了。</p>
<p>2.开放给用户空间的接口<br>在/sys/class/regulator/下面，有丰富的接口。<br>见<a href="https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-class-regulator" target="_blank" rel="noopener">https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-class-regulator</a></p>
<p>=============================regulator设备驱动分析=============================<br>regulator设备驱动，通常是作为mfd设备的一个cell而存在的。<br>所以可以直接使用mfd传过来的资源，例如regmap等。<br>但因为regulator和mfd之间的紧密的关联，有必要先分析下其对应的mfd设备，然后再分析regulator设备的驱动。</p>
<p>——————————-简单驱动之drivers/regulator/tps6507x-regulator.c分析——————————-<br>这个mfd和regulator驱动都很简单，适合入手分析：<br>先分析mfd驱动：drivers/mfd/tps6507x.c<br>首先是其cell的配置：<br>static const struct mfd_cell tps6507x_devs[] = {<br>    {<br>        .name = “tps6507x-pmic”,<br>    },<br>    {<br>        .name = “tps6507x-ts”,<br>    },<br>};<br>驱动的私有结构体：<br>struct tps6507x_dev {<br>    struct device <em>dev;<br>    struct i2c_client </em>i2c_client;<br>    int (<em>read_dev)(struct tps6507x_dev </em>tps6507x, char reg, int size,<br>            void <em>dest);<br>    int (</em>write_dev)(struct tps6507x_dev <em>tps6507x, char reg, int size,<br>             void </em>src);</p>
<pre><code>/* Client devices */
struct tps6507x_pmic *pmic;
</code></pre><p>};<br>probe的过程：<br>static int tps6507x_i2c_probe(struct i2c_client <em>i2c,<br>                const struct i2c_device_id </em>id)<br>{<br>    struct tps6507x_dev *tps6507x;</p>
<pre><code>tps6507x = devm_kzalloc(&amp;i2c-&gt;dev, sizeof(struct tps6507x_dev),
            GFP_KERNEL);
if (tps6507x == NULL)
    return -ENOMEM;

i2c_set_clientdata(i2c, tps6507x);---------------------设置好私有结构体
tps6507x-&gt;dev = &amp;i2c-&gt;dev;
tps6507x-&gt;i2c_client = i2c;
tps6507x-&gt;read_dev = tps6507x_i2c_read_device;
tps6507x-&gt;write_dev = tps6507x_i2c_write_device;

return devm_mfd_add_devices(tps6507x-&gt;dev, -1, tps6507x_devs,-------------------向mfd子系统注册
                ARRAY_SIZE(tps6507x_devs), NULL, 0, NULL);
</code></pre><p>}<br>非常简单<br>下面分析drivers/regulator/tps6507x-regulator.c<br>首先是probe函数：<br>static int tps6507x_pmic_probe(struct platform_device <em>pdev)<br>{<br>    struct tps6507x_dev </em>tps6507x_dev = dev_get_drvdata(pdev-&gt;dev.parent);——————–按照惯例，取出parent的私有结构体struct tps6507x_dev{}<br>    struct tps_info <em>info = &amp;tps6507x_pmic_regs[0];<br>    struct regulator_config config = { };<br>    struct regulator_init_data </em>init_data;<br>    struct regulator_dev <em>rdev;<br>    struct tps6507x_pmic </em>tps;<br>    struct tps6507x_board <em>tps_board;<br>    struct of_regulator_match </em>tps6507x_reg_matches = NULL;<br>    int i;<br>    int error;<br>    unsigned int prop;</p>
<pre><code>/**
 * tps_board points to pmic related constants
 * coming from the board-evm file.
 */

tps_board = dev_get_platdata(tps6507x_dev-&gt;dev);-------------------------取出machine信息，不管是板级文件写好的还是dts的都可以
if (IS_ENABLED(CONFIG_OF) &amp;&amp; !tps_board &amp;&amp;
    tps6507x_dev-&gt;dev-&gt;of_node)
    tps_board = tps6507x_parse_dt_reg_data(pdev,
            &amp;tps6507x_reg_matches);
if (!tps_board)
    return -EINVAL;

/**
 * init_data points to array of regulator_init structures
 * coming from the board-evm file.
 */
init_data = tps_board-&gt;tps6507x_pmic_init_data;-------------------machine信息中拿出regulator_init_data，至此regulator_init_data结构体已准备好
if (!init_data)
    return -EINVAL;

tps = devm_kzalloc(&amp;pdev-&gt;dev, sizeof(*tps), GFP_KERNEL);------------------这个是regulator驱动自己的私有结构体tps6507x_pmic，在内容上包括了他的parent也就是mfd芯片的私有结构体数据，以及
if (!tps)                                包含尚未初始化的regulator_desc（详见下面tps6507x_pmic{}结构体的代码）
    return -ENOMEM;

mutex_init(&amp;tps-&gt;io_lock);

/* common for all regulators */
tps-&gt;mfd = tps6507x_dev;-----------------------把他的parent也就是mfd芯片的私有结构体数据放入自己的私有结构体tps6507x_pmic
</code></pre><p>———–这个for循环是主体部分。做了这几件事：<br>——-1.把 tps6507x_pmic_regs[]中的那路的regulator操作方法细节的数据，填入tps6507x_pmic{}<br>——-2.填充regulator_desc，后续devm_regulator_register要用<br>——-3.用devm_regulator_register注册当前这路regulator输出<br>——-4.循环次数是DC-DC加LDO的数量的总和，也就是TPS6507X_NUM_REGULATOR</p>
<pre><code>for (i = 0; i &lt; TPS6507X_NUM_REGULATOR; i++, info++, init_data++) {
    /* Register the regulators */                    
    tps-&gt;info[i] = info;
    if (init_data-&gt;driver_data) {
        struct tps6507x_reg_platform_data *data =
                init_data-&gt;driver_data;
        tps-&gt;info[i]-&gt;defdcdc_default = data-&gt;defdcdc_default;
    }

    tps-&gt;desc[i].name = info-&gt;name;
    tps-&gt;desc[i].id = i;
    tps-&gt;desc[i].n_voltages = info-&gt;table_len;
    tps-&gt;desc[i].volt_table = info-&gt;table;
    tps-&gt;desc[i].ops = &amp;tps6507x_pmic_ops;-----------------这步也很重要，告诉regulator子系统，具体怎么操作regulator，读写怎么实现（其实是继承的mfd驱动里面的读写方法）
    tps-&gt;desc[i].type = REGULATOR_VOLTAGE;
    tps-&gt;desc[i].owner = THIS_MODULE;

    config.dev = tps6507x_dev-&gt;dev;
    config.init_data = init_data;------------------dts里面regulator_init_data信息，放入regulator_config 
    config.driver_data = tps;

    if (tps6507x_reg_matches) {
        error = of_property_read_u32(
            tps6507x_reg_matches[i].of_node,
                &quot;ti,defdcdc_default&quot;, &amp;prop);

        if (!error)
            tps-&gt;info[i]-&gt;defdcdc_default = prop;

        config.of_node = tps6507x_reg_matches[i].of_node;
    }

    rdev = devm_regulator_register(&amp;pdev-&gt;dev, &amp;tps-&gt;desc[i],
                       &amp;config);
    if (IS_ERR(rdev)) {
        dev_err(tps6507x_dev-&gt;dev,
            &quot;failed to register %s regulator\n&quot;,
            pdev-&gt;name);
        return PTR_ERR(rdev);
    }

    /* Save regulator for cleanup */
    tps-&gt;rdev[i] = rdev;
}

tps6507x_dev-&gt;pmic = tps;-------------------------------把tps6507x_pmic结构体放入父节点的私有数据的成员中
platform_set_drvdata(pdev, tps6507x_dev);

return 0;
</code></pre><p>}</p>
<p>struct tps6507x_pmic {<br>    struct regulator_desc desc[TPS6507X_NUM_REGULATOR];———————–regulator_desc{}是静态的描述每路regulator输出的细节的结构体，定义位于include/linux/regulator/driver.h<br>    struct tps6507x_dev <em>mfd;———————————————-他的parent也就是mfd芯片的私有结构体数据<br>    struct regulator_dev </em>rdev[TPS6507X_NUM_REGULATOR];<br>    struct tps_info *info[TPS6507X_NUM_REGULATOR];———-填充tps6507x_pmic_regs[]中的对应项。tps6507x_pmic_regs[]包含了如何设置每路regulator输出的细节(vsel)，例如LDO1_VSEL_table[]，后面有。<br>    struct mutex io_lock;<br>};</p>
<p>static struct tps_info tps6507x_pmic_regs[] = {<br>    {<br>        .name = “VDCDC1”,<br>        .table_len = ARRAY_SIZE(VDCDCx_VSEL_table),<br>        .table = VDCDCx_VSEL_table,<br>    },<br>    {<br>        .name = “VDCDC2”,<br>        .table_len = ARRAY_SIZE(VDCDCx_VSEL_table),<br>        .table = VDCDCx_VSEL_table,<br>    },<br>    {<br>        .name = “VDCDC3”,<br>        .table_len = ARRAY_SIZE(VDCDCx_VSEL_table),<br>        .table = VDCDCx_VSEL_table,<br>    },<br>    {<br>        .name = “LDO1”,<br>        .table_len = ARRAY_SIZE(LDO1_VSEL_table),<br>        .table = LDO1_VSEL_table,<br>    },<br>    {<br>        .name = “LDO2”,<br>        .table_len = ARRAY_SIZE(LDO2_VSEL_table),<br>        .table = LDO2_VSEL_table,<br>    },<br>};<br>static const unsigned int LDO1_VSEL_table[] = {————————最核心的数据之vsel表。因为操作regulator，电压不是连续可调的，是一档一档的。每一档是多少，要告诉regulator子系统。<br>    1000000, 1100000, 1200000, 1250000,<br>    1300000, 1350000, 1400000, 1500000,<br>    1600000, 1800000, 2500000, 2750000,<br>    2800000, 3000000, 3100000, 3300000,<br>};</p>
<p>这段洋洋洒洒很多内容，初看很晕，说简单点，做了什么呢？<br>最终目的是针对每一路regulator输出，都去注册一次devm_regulator_register<br>devm_regulator_register需要准备好下面几个入参：<br>struct regulator_dev <em>devm_regulator_register(struct device </em>dev,<br>                  const struct regulator_desc <em>regulator_desc,<br>                  const struct regulator_config </em>config)<br>dev不说了<br>regulator_desc包含了vsel表，操作regulator的回调函数ops，这些对操作regulator都是必须的，还包含名字，类型（电压型regulator）等，regulator驱动需要搜集并填充这些信息<br>regulator_config是什么？说白了就是当前dts里面配置的是什么电压什么电流，这部分regulator_init_data 信息。当然还包括一些别的成员，但主要是这个。<br>所以说白了，regulator_desc讲的是“怎么做”，而regulator_config讲的是“做成什么样”。</p>
<p>另外，这个tps6507x-regulator.c，在操作mfd的寄存器的时候，并未使用regmap，而是使用传统的方式：<br>static struct regulator_ops tps6507x_pmic_ops = {<br>    .is_enabled = tps6507x_pmic_is_enabled,<br>    .enable = tps6507x_pmic_enable,<br>    .disable = tps6507x_pmic_disable,<br>    .get_voltage_sel = tps6507x_pmic_get_voltage_sel,<br>    .set_voltage_sel = tps6507x_pmic_set_voltage_sel,<br>    .list_voltage = regulator_list_voltage_table,<br>    .map_voltage = regulator_map_voltage_ascend,<br>};<br>static int tps6507x_pmic_is_enabled(struct regulator_dev <em>dev)<br>{<br>    struct tps6507x_pmic </em>tps = rdev_get_drvdata(dev);<br>    int data, rid = rdev_get_id(dev);<br>    u8 shift;</p>
<pre><code>if (rid &lt; TPS6507X_DCDC_1 || rid &gt; TPS6507X_LDO_2)
    return -EINVAL;

shift = TPS6507X_MAX_REG_ID - rid;
data = tps6507x_pmic_reg_read(tps, TPS6507X_REG_CON_CTRL1);

if (data &lt; 0)
    return data;
else
    return (data &amp; 1&lt;&lt;shift) ? 1 : 0;
</code></pre><p>}<br>static int tps6507x_pmic_reg_read(struct tps6507x_pmic *tps, u8 reg)<br>{<br>    int data;</p>
<pre><code>mutex_lock(&amp;tps-&gt;io_lock);

data = tps6507x_pmic_read(tps, reg);
if (data &lt; 0)
    dev_err(tps-&gt;mfd-&gt;dev, &quot;Read from reg 0x%x failed\n&quot;, reg);

mutex_unlock(&amp;tps-&gt;io_lock);
return data;
</code></pre><p>}<br>static inline int tps6507x_pmic_read(struct tps6507x_pmic *tps, u8 reg)<br>{<br>    u8 val;<br>    int err;</p>
<pre><code>err = tps-&gt;mfd-&gt;read_dev(tps-&gt;mfd, reg, 1, &amp;val);

if (err)
    return err;

return val;
</code></pre><p>}<br>而这个read_dev，就是mfd驱动中私有结构体注册过的tps6507x_i2c_read_device<br>tps6507x-&gt;read_dev = tps6507x_i2c_read_device;</p>
<p>——————————-复杂驱动之drivers/regulator/palmas-regulator.c分析——————————-<br>以drivers/regulator/palmas-regulator.c为例分析。<br>mfd驱动是drivers/mfd/palmas.c<br>但其实这个drivers/mfd/palmas.c并非一个典型的mfd设备，因为并未使用mfd_add_devices向mfd子系统注册。<br>但这并不影响其作为mfd设备的功能：即初始化资源后，把资源作为私有数据，传给手下的那些cell驱动使用。<br>因为从dts节点上说，是存在父设备和子设备这样的继承关系的。<br>[待完善]</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/05/linux-PWM-framework/" rel="next" title="linux PWM framework">
                <i class="fa fa-chevron-left"></i> linux PWM framework
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/05/RTC-笔记/" rel="prev" title="RTC 笔记">
                RTC 笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Semiyd</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">230</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">118</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#下面针对提到的子系统的组件，做下详细的解释："><span class="nav-number">1.</span> <span class="nav-text">下面针对提到的子系统的组件，做下详细的解释：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最终xxx就是consumer-，ldo1是supplier"><span class="nav-number">2.</span> <span class="nav-text">最终xxx就是consumer ，ldo1是supplier</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#子系统核心逻辑"><span class="nav-number">3.</span> <span class="nav-text">子系统核心逻辑</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Semiyd</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
