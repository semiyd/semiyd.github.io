<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Regulator笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="Regulator笔记">
<meta property="og:url" content="http://yoursite.com/2018/08/05/Regulator笔记/index.html">
<meta property="og:site_name" content="Semiyd&#39;s Blog">
<meta property="og:description" content="Regulator笔记">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-08-05T02:36:30.922Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Regulator笔记">
<meta name="twitter:description" content="Regulator笔记">






  <link rel="canonical" href="http://yoursite.com/2018/08/05/Regulator笔记/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Regulator笔记 | Semiyd's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Semiyd's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/05/Regulator笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Semiyd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semiyd's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Regulator笔记
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-05 10:28:28 / Modified: 10:36:30" itemprop="dateCreated datePublished" datetime="2018-08-05T10:28:28+08:00">2018-08-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/Kernel/" itemprop="url" rel="index"><span itemprop="name">Kernel</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/Kernel/驱动/" itemprop="url" rel="index"><span itemprop="name">驱动</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/Kernel/驱动/Regulator/" itemprop="url" rel="index"><span itemprop="name">Regulator</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><center><strong>Regulator笔记</strong></center><br><a id="more"></a></p>
<h2 id="内核子系统之regulator"><a href="#内核子系统之regulator" class="headerlink" title="内核子系统之regulator"></a>内核子系统之regulator</h2><p>regulator子系统，是针对pmic类的芯片，针对电压电流的输出做调节之用。<br>在系统启动的时候，开启相应的电源供应<br>在有需要的时候，改变电源供应的电压/电流，达到提高能效的目的</p>
<p>考虑到实际硬件的电路情况，regulator子系统在设计的时候需要考虑下面几点：<br>1.所有电压/电流需要能事先规定一个最大/最小值作为有效范围。否则因为软件bug导致一旦超出范围，会烧毁硬件。<br>2.很多设备除了初始化的时候开下电源，别的时候完全不会去调节电压，需要尽量简化API接口。<br>3.硬件上电源这块经常存在级联的情况，一路电源的输入是另外一路电源的输出，在软件架构上要能反映出来（即supplier的概念）</p>
<p>整体软件架构参考“regulator子系统软件架构.png”<br>这个架构从下往上看，大体如下：<br>最底下是pmic的硬件<br>往上就是pmic的驱动<br>再往上就是子系统本身了。<br>子系统和驱动对接的部分，分成两块，driver和machine<br>所谓driver，就是类似devm_regulator_register这种接口，pmic的驱动用来向子系统注册。<br>所谓machine，是用来静态的配置电路上regulator的级联关系，最大/最小值范围等。早期是写在board文件里的，结构体名字是struct regulator_init_data。现在的内核其实就是写在dts里面的配置。<br>最终通过of_get_regulator_init_data接口，同样是去填充struct regulator_init_data。<br>再往上就是子系统核心部分的逻辑。对应代码就是drivers/regulator/core.c<br>最后和电源的使用者（成为consumer）做接口的，有两部分。<br>一部分是针对内核内部的consumer的，一部分是针对用户空间的consumer的（sysfs接口）。</p>
<p>下面针对提到的子系统的组件，做下详细的解释：</p>
<p><strong>driver:</strong><br>主要有两部分。<br>1.注册/注销pmic驱动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct regulator_dev *devm_regulator_register(struct device *dev,</span><br><span class="line">				  const struct regulator_desc *regulator_desc,</span><br><span class="line">				  const struct regulator_config *config)</span><br><span class="line">struct regulator_dev *regulator_register(struct regulator_desc *regulator_desc,</span><br><span class="line">					 const struct regulator_config *config);</span><br><span class="line">void regulator_unregister(struct regulator_dev *rdev);</span><br></pre></td></tr></table></figure></p>
<p>2.注册通知驱动层的回调函数<br>此举主要针对过热，过压等异常情况，需要通知驱动层的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int regulator_notifier_call_chain(struct regulator_dev *rdev,</span><br><span class="line">				  unsigned long event, void *data);</span><br><span class="line">int regulator_register_notifier(struct regulator *regulator,</span><br><span class="line">			      struct notifier_block *nb)</span><br></pre></td></tr></table></figure></p>
<p><strong>machine:</strong><br>这个组件，对外的接口，其实主要就是这个regulator_init_data结构体：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct regulator_init_data &#123;</span><br><span class="line">	const char *supply_regulator;        /* or NULL for system supply */</span><br><span class="line"></span><br><span class="line">	struct regulation_constraints constraints;</span><br><span class="line"></span><br><span class="line">	int num_consumer_supplies;</span><br><span class="line">	struct regulator_consumer_supply *consumer_supplies;</span><br><span class="line"></span><br><span class="line">	/* optional regulator machine specific init */</span><br><span class="line">	int (*regulator_init)(void *driver_data);</span><br><span class="line">	void *driver_data;	/* core does not touch this */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这个结构体，可以在板级board文件里面填充好，也可以在dts里面写好，通过of_get_regulator_init_data接口来填充。<br>而这个结构体，作为regulator_config的一个成员。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct regulator_config &#123;</span><br><span class="line">	struct device *dev;</span><br><span class="line">	const struct regulator_init_data *init_data;</span><br><span class="line">	void *driver_data;</span><br><span class="line">	struct device_node *of_node;</span><br><span class="line">	struct regmap *regmap;</span><br><span class="line"></span><br><span class="line">	bool ena_gpio_initialized;</span><br><span class="line">	int ena_gpio;</span><br><span class="line">	unsigned int ena_gpio_invert:1;</span><br><span class="line">	unsigned int ena_gpio_flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>最终跟着regulator_config{}，依靠devm_regulator_register注册到regulator子系统里面去。</p>
<p>下面举个例子来说明具体的配置过程：<br>假设硬件上有如下的级联结构：<br>Regulator-1 -+-&gt; Regulator-2 –&gt; [Consumer A @ 1.8 - 2.0V]<br>&emsp;&emsp;&emsp;&emsp;&emsp;|<br>&emsp;&emsp;&emsp;&emsp;&emsp;+-&gt; [Consumer B @ 3.3V]<br>可以看到，硬件上，A是从Regulator-2供电，B是从Regulator-1供电。而Regulator-2也是从Regulator-1供电的。<br>如何从软件角度去描述上面这个电路？<br>machine子系统提供一个regulator_consumer_supply的结构体，专门用来描述supplier和consumer之间的关系：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct regulator_consumer_supply &#123;</span><br><span class="line">	const char *dev_name;	/* consumer dev_name() */</span><br><span class="line">	const char *supply;	/* consumer supply - e.g. &quot;vcc&quot; */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>具体到此处就是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static struct regulator_consumer_supply regulator1_consumers[] = &#123;</span><br><span class="line">&#123;</span><br><span class="line">	.dev_name	= &quot;consumer B&quot;,</span><br><span class="line">	.supply		= &quot;Vcc&quot;,</span><br><span class="line">&#125;,&#125;;</span><br><span class="line"></span><br><span class="line">static struct regulator_consumer_supply regulator2_consumers[] = &#123;</span><br><span class="line">&#123;</span><br><span class="line">	.dev	= &quot;consumer A&quot;,</span><br><span class="line">	.supply	= &quot;Vcc&quot;,</span><br><span class="line">&#125;,&#125;;</span><br></pre></td></tr></table></figure></p>
<p>但此处尚未涉及如何描述regulator之间的级联。别急，接着往下看：<br>这时候就可以填充regulator_init_data了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static struct regulator_init_data regulator1_data = &#123;</span><br><span class="line">	.constraints = &#123;</span><br><span class="line">		.name = &quot;Regulator-1&quot;,</span><br><span class="line">		.min_uV = 3300000,</span><br><span class="line">		.max_uV = 3300000,</span><br><span class="line">		.valid_modes_mask = REGULATOR_MODE_NORMAL,</span><br><span class="line">	&#125;,</span><br><span class="line">	.num_consumer_supplies = ARRAY_SIZE(regulator1_consumers),</span><br><span class="line">	.consumer_supplies = regulator1_consumers,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，在regulator_init_data，需要填上刚刚涉及的regulator_consumer_supply内容。<br>除此以外，还填充了最大/最小电压；<br>设置了valid_modes_mask。有关这个mode，见下面的解释：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">*  Mode       Description</span><br><span class="line">*  FAST       Regulator can handle fast changes in it&apos;s load.</span><br><span class="line">*             e.g. useful in CPU voltage &amp; frequency scaling where</span><br><span class="line">*             load can quickly increase with CPU frequency increases.</span><br><span class="line">*</span><br><span class="line">*  NORMAL     Normal regulator power supply mode. Most drivers will</span><br><span class="line">*             use this mode.</span><br><span class="line">*</span><br><span class="line">*  IDLE       Regulator runs in a more efficient mode for light</span><br><span class="line">*             loads. Can be used for devices that have a low power</span><br><span class="line">*             requirement during periods of inactivity. This mode</span><br><span class="line">*             may be more noisy than NORMAL and may not be able</span><br><span class="line">*             to handle fast load switching.</span><br><span class="line">*</span><br><span class="line">*  STANDBY    Regulator runs in the most efficient mode for very</span><br><span class="line">*             light loads. Can be used by devices when they are</span><br><span class="line">*             in a sleep/standby state. This mode is likely to be</span><br><span class="line">*             the most noisy and may not be able to handle fast load</span><br><span class="line">*             switching.</span><br><span class="line">*</span><br><span class="line">* NOTE: Most regulators will only support a subset of these modes. Some</span><br><span class="line">* will only just support NORMAL.</span><br><span class="line">*</span><br><span class="line">* These modes can be OR&apos;ed together to make up a mask of valid register modes.</span><br><span class="line">*/</span><br></pre></td></tr></table></figure></p>
<p>上面是Regulator-1，接着看Regulator-2：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static struct regulator_init_data regulator2_data = &#123;</span><br><span class="line">	.supply_regulator = &quot;Regulator-1&quot;,</span><br><span class="line">	.constraints = &#123;</span><br><span class="line">		.min_uV = 1800000,</span><br><span class="line">		.max_uV = 2000000,</span><br><span class="line">		.valid_ops_mask = REGULATOR_CHANGE_VOLTAGE,</span><br><span class="line">		.valid_modes_mask = REGULATOR_MODE_NORMAL,</span><br><span class="line">	&#125;,</span><br><span class="line">	.num_consumer_supplies = ARRAY_SIZE(regulator2_consumers),</span><br><span class="line">	.consumer_supplies = regulator2_consumers,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，此处就写清楚了Regulator-1和Regulator-2的关系，依靠supply_regulator成员。<br>将来Consumer A如果要打开电源，core部分就会根据这个级联信息，同时打开Regulator-1和Regulator-2。</p>
<p>最后，把这两个regulator_init_data{}，作为.platform_data，注册到platform_device里面去。<br>有两个regulator_init_data{}，就注册两个platform_device<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">static struct platform_device regulator_devices[] = &#123;</span><br><span class="line">&#123;</span><br><span class="line">	.name = &quot;regulator&quot;,</span><br><span class="line">	.id = DCDC_1,</span><br><span class="line">	.dev = &#123;</span><br><span class="line">		.platform_data = &amp;regulator1_data,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">	.name = &quot;regulator&quot;,</span><br><span class="line">	.id = DCDC_2,</span><br><span class="line">	.dev = &#123;</span><br><span class="line">		.platform_data = &amp;regulator2_data,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">/* register regulator 1 device */</span><br><span class="line">platform_device_register(&amp;regulator_devices[0]);</span><br><span class="line"></span><br><span class="line">/* register regulator 2 device */</span><br><span class="line">platform_device_register(&amp;regulator_devices[1]);</span><br></pre></td></tr></table></figure></p>
<p>相应的，在regulator cell的platform_driver驱动里面，会针对这两个platform_device做两次probe，从而做两次devm_regulator_register，把这两个regulator设备都注册到子系统里面去。</p>
<p>除了在板级初始化代码里面配置regulator_init_data{}以为，目前主要的方式是在dts下配置：<br>例如下面这个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">tps659038_pmic &#123;</span><br><span class="line">	compatible = &quot;ti,tps659038-pmic&quot;;</span><br><span class="line"></span><br><span class="line">	smps12-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	smps3-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	smps45-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	smps6-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	smps7-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	smps8-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	smps9-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	ldo1-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	ldo2-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	ldo3-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	ldo4-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	ldo9-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	ldoln-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	ldousb-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line">	ldortc-in-supply = &lt;&amp;vmain&gt;;</span><br><span class="line"></span><br><span class="line">	regulators &#123;</span><br><span class="line">		smps12_reg: smps12 &#123;</span><br><span class="line">			/* VDD_MPU */</span><br><span class="line">			regulator-name = &quot;smps12&quot;;</span><br><span class="line">			regulator-min-microvolt = &lt;850000&gt;;</span><br><span class="line">			regulator-max-microvolt = &lt;1250000&gt;;</span><br><span class="line">			regulator-always-on;</span><br><span class="line">			regulator-boot-on;</span><br><span class="line">		&#125;;</span><br><span class="line">		...等等各路输出的配置</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>dts里面完全可以配置出刚刚用板级文件填写的那些结构体信息。</p>
<p><strong>core</strong><br>子系统核心逻辑</p>
<p><strong>consumer接口</strong><br>1.开放给内核内部的接口。<br>这部分接口高度类似clk子系统的接口。</p>
<p>获取和释放regulator:<br>regulator = regulator_get(dev, “Vcc”);            获取，通常在consumer驱动probe的时候做<br>regulator_put(regulator);                释放，通常在consumer驱动remove的时候做</p>
<p>开启regulator:<br>int regulator_enable(regulator);<br>如果已经开启（有别的consumer在用），则不会重复开启</p>
<p>关闭regulator：<br>int regulator_disable(regulator);<br>如果有别的consumer在用，则无法关闭。</p>
<p>紧急关闭regulator：<br>int regulator_force_disable(regulator);<br>无视别的consumer，直接关闭。</p>
<p>动态调整电压（通常用于cpufreq驱动，sd驱动针对不同速率需要不同电压）<br>int regulator_set_voltage(regulator, min_uV, max_uV);</p>
<p>获取当前电压的设置<br>int regulator_get_voltage(regulator);<br>无法体现是否电压正在输出，只能获取电压值的设定。所以需要配合int regulator_is_enabled(regulator);来判定是否是实际输出的电压。</p>
<p>动态调整电流（通常用于lcd backlight驱动，usb驱动限流500mA）<br>int regulator_set_current_limit(regulator, min_uA, max_uA);</p>
<p>获取当前电流的设置<br>int regulator_get_current_limit(regulator);<br>无法体现是否电流正在输出，只能获取电流值的设定。所以需要配合int regulator_is_enabled(regulator);来判定是否是实际输出的电流。</p>
<p>regulator模式的设置（不常用）<br>这里的模式，是指之前提到过的FAST  NORMAL IDLE STANDBY<br>根据实际使用的情况，针对regulator设置正确的模式，可以省电。<br>consumer可以通过下面两个API来影响regulator的模式（如果有模式可以选。也可能regulator注册的时候只有一种模式。）<br>int regulator_set_load(struct regulator <em>regulator, int load_uA);<br>告诉子系统，当前的load是多少，让子系统结合别的consumer的情况，来决定模式。<br>int regulator_set_mode(struct regulator </em>regulator, unsigned int mode);<br>直接暴力设置模式，无视别的consumer的情况</p>
<p>直接操作regulator寄存器<br>借助regmap子系统，consumer可以获取regulator具体的操作方式（i2c? 寄存器的值，寄存器号？等等）<br>struct regmap <em>regulator_get_regmap(struct regulator </em>regulator);<br>int regulator_get_hardware_vsel_register(struct regulator <em>regulator,<br>                     unsigned </em>vsel_reg,<br>                     unsigned <em>vsel_mask);<br>int regulator_list_hardware_vsel(struct regulator </em>regulator,<br>                 unsigned selector);<br>举例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">regmap = regulator_get_regmap(td-&gt;vdd_reg);</span><br><span class="line">i2c_dev = regmap_get_device(regmap);</span><br><span class="line">i2c_client = to_i2c_client(i2c_dev);</span><br><span class="line">td-&gt;i2c_slave_addr = i2c_client-&gt;addr;</span><br><span class="line">ret = regulator_get_hardware_vsel_register(td-&gt;vdd_reg,</span><br><span class="line">					   &amp;vsel_reg,</span><br><span class="line">					   &amp;vsel_mask);</span><br><span class="line">if (ret &lt; 0) &#123;</span><br><span class="line">	dev_err(td-&gt;dev,</span><br><span class="line">		&quot;regulator unsuitable for DFLL I2C operation\n&quot;);</span><br><span class="line">	return -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line">td-&gt;i2c_reg = vsel_reg;</span><br><span class="line">ret = dfll_build_i2c_lut(td);//至此，获取了操作i2c寄存器的具体细节，可以真正来直接读写i2c寄存器了。</span><br></pre></td></tr></table></figure></p>
<p>2.开放给用户空间的接口<br>在/sys/class/regulator/下面，有丰富的接口。<br>见<a href="https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-class-regulator" target="_blank" rel="noopener">https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-class-regulator</a></p>
<h2 id="regulator设备驱动分析"><a href="#regulator设备驱动分析" class="headerlink" title="regulator设备驱动分析"></a>regulator设备驱动分析</h2><p>regulator设备驱动，通常是作为mfd设备的一个cell而存在的。<br>所以可以直接使用mfd传过来的资源，例如regmap等。<br>但因为regulator和mfd之间的紧密的关联，有必要先分析下其对应的mfd设备，然后再分析regulator设备的驱动。</p>
<p>——————————-简单驱动之drivers/regulator/tps6507x-regulator.c分析——————————-<br>这个mfd和regulator驱动都很简单，适合入手分析：<br>先分析mfd驱动：drivers/mfd/tps6507x.c<br>首先是其cell的配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static const struct mfd_cell tps6507x_devs[] = &#123;</span><br><span class="line">	&#123;</span><br><span class="line">		.name = &quot;tps6507x-pmic&quot;,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.name = &quot;tps6507x-ts&quot;,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>驱动的私有结构体：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct tps6507x_dev &#123;</span><br><span class="line">	struct device *dev;</span><br><span class="line">	struct i2c_client *i2c_client;</span><br><span class="line">	int (*read_dev)(struct tps6507x_dev *tps6507x, char reg, int size,</span><br><span class="line">			void *dest);</span><br><span class="line">	int (*write_dev)(struct tps6507x_dev *tps6507x, char reg, int size,</span><br><span class="line">			 void *src);</span><br><span class="line"></span><br><span class="line">	/* Client devices */</span><br><span class="line">	struct tps6507x_pmic *pmic;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>probe的过程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static int tps6507x_i2c_probe(struct i2c_client *i2c,</span><br><span class="line">			    const struct i2c_device_id *id)</span><br><span class="line">&#123;</span><br><span class="line">	struct tps6507x_dev *tps6507x;</span><br><span class="line"></span><br><span class="line">	tps6507x = devm_kzalloc(&amp;i2c-&gt;dev, sizeof(struct tps6507x_dev),</span><br><span class="line">				GFP_KERNEL);</span><br><span class="line">	if (tps6507x == NULL)</span><br><span class="line">		return -ENOMEM;</span><br><span class="line"></span><br><span class="line">	i2c_set_clientdata(i2c, tps6507x);---------------------设置好私有结构体</span><br><span class="line">	tps6507x-&gt;dev = &amp;i2c-&gt;dev;</span><br><span class="line">	tps6507x-&gt;i2c_client = i2c;</span><br><span class="line">	tps6507x-&gt;read_dev = tps6507x_i2c_read_device;</span><br><span class="line">	tps6507x-&gt;write_dev = tps6507x_i2c_write_device;</span><br><span class="line"></span><br><span class="line">	return devm_mfd_add_devices(tps6507x-&gt;dev, -1, tps6507x_devs,-------------------向mfd子系统注册</span><br><span class="line">				    ARRAY_SIZE(tps6507x_devs), NULL, 0, NULL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>非常简单<br>下面分析drivers/regulator/tps6507x-regulator.c<br>首先是probe函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">static int tps6507x_pmic_probe(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">	struct tps6507x_dev *tps6507x_dev = dev_get_drvdata(pdev-&gt;dev.parent);--------------------按照惯例，取出parent的私有结构体struct tps6507x_dev&#123;&#125;</span><br><span class="line">	struct tps_info *info = &amp;tps6507x_pmic_regs[0];</span><br><span class="line">	struct regulator_config config = &#123; &#125;;</span><br><span class="line">	struct regulator_init_data *init_data;</span><br><span class="line">	struct regulator_dev *rdev;</span><br><span class="line">	struct tps6507x_pmic *tps;</span><br><span class="line">	struct tps6507x_board *tps_board;</span><br><span class="line">	struct of_regulator_match *tps6507x_reg_matches = NULL;</span><br><span class="line">	int i;</span><br><span class="line">	int error;</span><br><span class="line">	unsigned int prop;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * tps_board points to pmic related constants</span><br><span class="line">	 * coming from the board-evm file.</span><br><span class="line">	 */</span><br><span class="line"></span><br><span class="line">	tps_board = dev_get_platdata(tps6507x_dev-&gt;dev);-------------------------取出machine信息，不管是板级文件写好的还是dts的都可以</span><br><span class="line">	if (IS_ENABLED(CONFIG_OF) &amp;&amp; !tps_board &amp;&amp;</span><br><span class="line">		tps6507x_dev-&gt;dev-&gt;of_node)</span><br><span class="line">		tps_board = tps6507x_parse_dt_reg_data(pdev,</span><br><span class="line">				&amp;tps6507x_reg_matches);</span><br><span class="line">	if (!tps_board)</span><br><span class="line">		return -EINVAL;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * init_data points to array of regulator_init structures</span><br><span class="line">	 * coming from the board-evm file.</span><br><span class="line">	 */</span><br><span class="line">	init_data = tps_board-&gt;tps6507x_pmic_init_data;-------------------machine信息中拿出regulator_init_data，至此regulator_init_data结构体已准备好</span><br><span class="line">	if (!init_data)</span><br><span class="line">		return -EINVAL;</span><br><span class="line"></span><br><span class="line">	tps = devm_kzalloc(&amp;pdev-&gt;dev, sizeof(*tps), GFP_KERNEL);------------------这个是regulator驱动自己的私有结构体tps6507x_pmic，在内容上包括了他的parent也就是mfd芯片的私有结构体数据，以及</span><br><span class="line">	if (!tps)								包含尚未初始化的regulator_desc（详见下面tps6507x_pmic&#123;&#125;结构体的代码）</span><br><span class="line">		return -ENOMEM;</span><br><span class="line"></span><br><span class="line">	mutex_init(&amp;tps-&gt;io_lock);</span><br><span class="line"></span><br><span class="line">	/* common for all regulators */</span><br><span class="line">	tps-&gt;mfd = tps6507x_dev;-----------------------把他的parent也就是mfd芯片的私有结构体数据放入自己的私有结构体tps6507x_pmic</span><br><span class="line"></span><br><span class="line">-----------这个for循环是主体部分。做了这几件事：</span><br><span class="line">-------1.把 tps6507x_pmic_regs[]中的那路的regulator操作方法细节的数据，填入tps6507x_pmic&#123;&#125;</span><br><span class="line">-------2.填充regulator_desc，后续devm_regulator_register要用</span><br><span class="line">-------3.用devm_regulator_register注册当前这路regulator输出</span><br><span class="line">-------4.循环次数是DC-DC加LDO的数量的总和，也就是TPS6507X_NUM_REGULATOR</span><br><span class="line"></span><br><span class="line">	for (i = 0; i &lt; TPS6507X_NUM_REGULATOR; i++, info++, init_data++) &#123;</span><br><span class="line">		/* Register the regulators */					</span><br><span class="line">		tps-&gt;info[i] = info;</span><br><span class="line">		if (init_data-&gt;driver_data) &#123;</span><br><span class="line">			struct tps6507x_reg_platform_data *data =</span><br><span class="line">					init_data-&gt;driver_data;</span><br><span class="line">			tps-&gt;info[i]-&gt;defdcdc_default = data-&gt;defdcdc_default;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tps-&gt;desc[i].name = info-&gt;name;</span><br><span class="line">		tps-&gt;desc[i].id = i;</span><br><span class="line">		tps-&gt;desc[i].n_voltages = info-&gt;table_len;</span><br><span class="line">		tps-&gt;desc[i].volt_table = info-&gt;table;</span><br><span class="line">		tps-&gt;desc[i].ops = &amp;tps6507x_pmic_ops;-----------------这步也很重要，告诉regulator子系统，具体怎么操作regulator，读写怎么实现（其实是继承的mfd驱动里面的读写方法）</span><br><span class="line">		tps-&gt;desc[i].type = REGULATOR_VOLTAGE;</span><br><span class="line">		tps-&gt;desc[i].owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">		config.dev = tps6507x_dev-&gt;dev;</span><br><span class="line">		config.init_data = init_data;------------------dts里面regulator_init_data信息，放入regulator_config </span><br><span class="line">		config.driver_data = tps;</span><br><span class="line"></span><br><span class="line">		if (tps6507x_reg_matches) &#123;</span><br><span class="line">			error = of_property_read_u32(</span><br><span class="line">				tps6507x_reg_matches[i].of_node,</span><br><span class="line">					&quot;ti,defdcdc_default&quot;, &amp;prop);</span><br><span class="line"></span><br><span class="line">			if (!error)</span><br><span class="line">				tps-&gt;info[i]-&gt;defdcdc_default = prop;</span><br><span class="line"></span><br><span class="line">			config.of_node = tps6507x_reg_matches[i].of_node;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		rdev = devm_regulator_register(&amp;pdev-&gt;dev, &amp;tps-&gt;desc[i],</span><br><span class="line">					       &amp;config);</span><br><span class="line">		if (IS_ERR(rdev)) &#123;</span><br><span class="line">			dev_err(tps6507x_dev-&gt;dev,</span><br><span class="line">				&quot;failed to register %s regulator\n&quot;,</span><br><span class="line">				pdev-&gt;name);</span><br><span class="line">			return PTR_ERR(rdev);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		/* Save regulator for cleanup */</span><br><span class="line">		tps-&gt;rdev[i] = rdev;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tps6507x_dev-&gt;pmic = tps;-------------------------------把tps6507x_pmic结构体放入父节点的私有数据的成员中</span><br><span class="line">	platform_set_drvdata(pdev, tps6507x_dev);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct tps6507x_pmic &#123;</span><br><span class="line">	struct regulator_desc desc[TPS6507X_NUM_REGULATOR];-----------------------regulator_desc&#123;&#125;是静态的描述每路regulator输出的细节的结构体，定义位于include/linux/regulator/driver.h</span><br><span class="line">	struct tps6507x_dev *mfd;----------------------------------------------他的parent也就是mfd芯片的私有结构体数据</span><br><span class="line">	struct regulator_dev *rdev[TPS6507X_NUM_REGULATOR];</span><br><span class="line">	struct tps_info *info[TPS6507X_NUM_REGULATOR];----------填充tps6507x_pmic_regs[]中的对应项。tps6507x_pmic_regs[]包含了如何设置每路regulator输出的细节(vsel)，例如LDO1_VSEL_table[]，后面有。</span><br><span class="line">	struct mutex io_lock;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct tps_info tps6507x_pmic_regs[] = &#123;</span><br><span class="line">	&#123;</span><br><span class="line">		.name = &quot;VDCDC1&quot;,</span><br><span class="line">		.table_len = ARRAY_SIZE(VDCDCx_VSEL_table),</span><br><span class="line">		.table = VDCDCx_VSEL_table,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.name = &quot;VDCDC2&quot;,</span><br><span class="line">		.table_len = ARRAY_SIZE(VDCDCx_VSEL_table),</span><br><span class="line">		.table = VDCDCx_VSEL_table,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.name = &quot;VDCDC3&quot;,</span><br><span class="line">		.table_len = ARRAY_SIZE(VDCDCx_VSEL_table),</span><br><span class="line">		.table = VDCDCx_VSEL_table,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.name = &quot;LDO1&quot;,</span><br><span class="line">		.table_len = ARRAY_SIZE(LDO1_VSEL_table),</span><br><span class="line">		.table = LDO1_VSEL_table,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.name = &quot;LDO2&quot;,</span><br><span class="line">		.table_len = ARRAY_SIZE(LDO2_VSEL_table),</span><br><span class="line">		.table = LDO2_VSEL_table,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">static const unsigned int LDO1_VSEL_table[] = &#123;------------------------最核心的数据之vsel表。因为操作regulator，电压不是连续可调的，是一档一档的。每一档是多少，要告诉regulator子系统。</span><br><span class="line">	1000000, 1100000, 1200000, 1250000,</span><br><span class="line">	1300000, 1350000, 1400000, 1500000,</span><br><span class="line">	1600000, 1800000, 2500000, 2750000,</span><br><span class="line">	2800000, 3000000, 3100000, 3300000,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这段洋洋洒洒很多内容，初看很晕，说简单点，做了什么呢？<br>最终目的是针对每一路regulator输出，都去注册一次devm_regulator_register<br>devm_regulator_register需要准备好下面几个入参：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct regulator_dev *devm_regulator_register(struct device *dev,</span><br><span class="line">				  const struct regulator_desc *regulator_desc,</span><br><span class="line">				  const struct regulator_config *config)</span><br></pre></td></tr></table></figure></p>
<p>dev不说了<br>regulator_desc包含了vsel表，操作regulator的回调函数ops，这些对操作regulator都是必须的，还包含名字，类型（电压型regulator）等，regulator驱动需要搜集并填充这些信息<br>regulator_config是什么？说白了就是当前dts里面配置的是什么电压什么电流，这部分regulator_init_data 信息。当然还包括一些别的成员，但主要是这个。<br>所以说白了，regulator_desc讲的是“怎么做”，而regulator_config讲的是“做成什么样”。</p>
<p>另外，这个tps6507x-regulator.c，在操作mfd的寄存器的时候，并未使用regmap，而是使用传统的方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">static struct regulator_ops tps6507x_pmic_ops = &#123;</span><br><span class="line">	.is_enabled = tps6507x_pmic_is_enabled,</span><br><span class="line">	.enable = tps6507x_pmic_enable,</span><br><span class="line">	.disable = tps6507x_pmic_disable,</span><br><span class="line">	.get_voltage_sel = tps6507x_pmic_get_voltage_sel,</span><br><span class="line">	.set_voltage_sel = tps6507x_pmic_set_voltage_sel,</span><br><span class="line">	.list_voltage = regulator_list_voltage_table,</span><br><span class="line">	.map_voltage = regulator_map_voltage_ascend,</span><br><span class="line">&#125;;</span><br><span class="line">static int tps6507x_pmic_is_enabled(struct regulator_dev *dev)</span><br><span class="line">&#123;</span><br><span class="line">	struct tps6507x_pmic *tps = rdev_get_drvdata(dev);</span><br><span class="line">	int data, rid = rdev_get_id(dev);</span><br><span class="line">	u8 shift;</span><br><span class="line"></span><br><span class="line">	if (rid &lt; TPS6507X_DCDC_1 || rid &gt; TPS6507X_LDO_2)</span><br><span class="line">		return -EINVAL;</span><br><span class="line"></span><br><span class="line">	shift = TPS6507X_MAX_REG_ID - rid;</span><br><span class="line">	data = tps6507x_pmic_reg_read(tps, TPS6507X_REG_CON_CTRL1);</span><br><span class="line"></span><br><span class="line">	if (data &lt; 0)</span><br><span class="line">		return data;</span><br><span class="line">	else</span><br><span class="line">		return (data &amp; 1&lt;&lt;shift) ? 1 : 0;</span><br><span class="line">&#125;</span><br><span class="line">static int tps6507x_pmic_reg_read(struct tps6507x_pmic *tps, u8 reg)</span><br><span class="line">&#123;</span><br><span class="line">	int data;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;tps-&gt;io_lock);</span><br><span class="line"></span><br><span class="line">	data = tps6507x_pmic_read(tps, reg);</span><br><span class="line">	if (data &lt; 0)</span><br><span class="line">		dev_err(tps-&gt;mfd-&gt;dev, &quot;Read from reg 0x%x failed\n&quot;, reg);</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;tps-&gt;io_lock);</span><br><span class="line">	return data;</span><br><span class="line">&#125;</span><br><span class="line">static inline int tps6507x_pmic_read(struct tps6507x_pmic *tps, u8 reg)</span><br><span class="line">&#123;</span><br><span class="line">	u8 val;</span><br><span class="line">	int err;</span><br><span class="line"></span><br><span class="line">	err = tps-&gt;mfd-&gt;read_dev(tps-&gt;mfd, reg, 1, &amp;val);</span><br><span class="line"></span><br><span class="line">	if (err)</span><br><span class="line">		return err;</span><br><span class="line"></span><br><span class="line">	return val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而这个read_dev，就是mfd驱动中私有结构体注册过的tps6507x_i2c_read_device<br>tps6507x-&gt;read_dev = tps6507x_i2c_read_device;</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/05/linux-PWM-framework/" rel="next" title="linux PWM framework">
                <i class="fa fa-chevron-left"></i> linux PWM framework
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/05/RTC-笔记/" rel="prev" title="RTC 笔记">
                RTC 笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Semiyd</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">195</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">90</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#内核子系统之regulator"><span class="nav-number">1.</span> <span class="nav-text">内核子系统之regulator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#regulator设备驱动分析"><span class="nav-number">2.</span> <span class="nav-text">regulator设备驱动分析</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Semiyd</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
